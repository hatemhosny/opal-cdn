Opal.modules.promise=function(Opal){function $rb_plus(lhs,rhs){return"number"==typeof lhs&&"number"==typeof rhs?lhs+rhs:lhs["$+"](rhs)}Opal.top;var $nesting=[],nil=Opal.nil,$$=(Opal.$$$,Opal.$$),$klass=Opal.klass,$hash2=Opal.hash2,$truthy=Opal.truthy,$send=Opal.send,$send2=Opal.send2;return Opal.add_stubs(["$resolve","$new","$reject","$attr_reader","$===","$value","$key?","$keys","$!=","$==","$<<","$>>","$exception?","$[]","$resolved?","$rejected?","$!","$error","$include?","$action","$realized?","$raise","$^","$call","$resolve!","$exception!","$any?","$each","$reject!","$there_can_be_only_one!","$then","$to_proc","$fail","$always","$trace","$class","$object_id","$+","$inspect","$act?","$nil?","$prev","$push","$concat","$it","$proc","$reverse","$pop","$<=","$length","$shift","$-","$wait","$map","$reduce","$try","$tap","$all?","$find"]),function(self,$Promise_inspect$31){var $Promise_then$22,$Promise_then$excl$23,$Promise_fail$24,$Promise_fail$excl$25,$Promise_always$26,$Promise_always$excl$27,$Promise_trace$28,$Promise_trace$excl$29,self=$klass(self,null,"Promise"),$nesting=[self].concat($Promise_inspect$31);return self.$$prototype.value=self.$$prototype.action=self.$$prototype.exception=self.$$prototype.realized=self.$$prototype.next=self.$$prototype.delayed=self.$$prototype.error=self.$$prototype.prev=nil,Opal.defs(self,"$value",$Promise_inspect$31=function(value){return this.$new().$resolve(value)},$Promise_inspect$31.$$arity=1),Opal.defs(self,"$error",$Promise_inspect$31=function(value){return this.$new().$reject(value)},$Promise_inspect$31.$$arity=1),Opal.defs(self,"$when",$Promise_inspect$31=function($a){var promises=Opal.slice.call(arguments,0,arguments.length);return $$($nesting,"When").$new(promises)},$Promise_inspect$31.$$arity=-1),self.$attr_reader("error","prev","next"),Opal.def(self,"$initialize",$Promise_inspect$31=function(action){return null==action&&(action=$hash2([],{})),this.action=action,this.realized=!1,this.exception=!1,this.value=nil,this.error=nil,this.delayed=!1,this.prev=nil,this.next=[]},$Promise_inspect$31.$$arity=-1),Opal.def(self,"$value",$Promise_inspect$31=function(){return $truthy($$($nesting,"Promise")["$==="](this.value))?this.value.$value():this.value},$Promise_inspect$31.$$arity=0),Opal.def(self,"$act?",$Promise_inspect$31=function(){var $ret_or_1;return $truthy($ret_or_1=this.action["$key?"]("success"))?$ret_or_1:this.action["$key?"]("always")},$Promise_inspect$31.$$arity=0),Opal.def(self,"$action",$Promise_inspect$31=function(){return this.action.$keys()},$Promise_inspect$31.$$arity=0),Opal.def(self,"$exception?",$Promise_inspect$31=function(){return this.exception},$Promise_inspect$31.$$arity=0),Opal.def(self,"$realized?",$Promise_inspect$31=function(){return this.realized["$!="](!1)},$Promise_inspect$31.$$arity=0),Opal.def(self,"$resolved?",$Promise_inspect$31=function(){return this.realized["$=="]("resolve")},$Promise_inspect$31.$$arity=0),Opal.def(self,"$rejected?",$Promise_inspect$31=function(){return this.realized["$=="]("reject")},$Promise_inspect$31.$$arity=0),Opal.def(self,"$^",$Promise_inspect$31=function(promise){return promise["$<<"](this),this["$>>"](promise),promise},$Promise_inspect$31.$$arity=1),Opal.def(self,"$<<",$Promise_inspect$31=function(promise){return this.prev=promise,this},$Promise_inspect$31.$$arity=1),Opal.def(self,"$>>",$Promise_inspect$31=function(promise){var self=this,$ret_or_2=nil;return self.next["$<<"](promise),$truthy(self["$exception?"]())?promise.$reject(self.delayed["$[]"](0)):$truthy(self["$resolved?"]())?promise.$resolve($truthy(self.delayed)?self.delayed["$[]"](0):self.$value()):$truthy(self["$rejected?"]())&&($truthy($truthy($ret_or_2=self.action["$key?"]("failure")["$!"]())?$ret_or_2:$$($nesting,"Promise")["$==="]($truthy(self.delayed)?self.delayed["$[]"](0):self.error))||$truthy(promise.$action()["$include?"]("always")))&&promise.$reject($truthy(self.delayed)?self.delayed["$[]"](0):self.$error()),self},$Promise_inspect$31.$$arity=1),Opal.def(self,"$resolve",$Promise_inspect$31=function(value){var e,self=this,block=nil,$ret_or_3=nil;if(null==value&&(value=nil),$truthy(self["$realized?"]())&&self.$raise($$($nesting,"ArgumentError"),"the promise has already been realized"),$truthy($$($nesting,"Promise")["$==="](value)))return value["$<<"](self.prev)["$^"](self);try{block=$truthy($ret_or_3=self.action["$[]"]("success"))?$ret_or_3:self.action["$[]"]("always"),$truthy(block)&&(value=block.$call(value)),self["$resolve!"](value)}catch($err){if(!Opal.rescue($err,[$$($nesting,"Exception")]))throw $err;e=$err;try{self["$exception!"](e)}finally{Opal.pop_exception()}}return self},$Promise_inspect$31.$$arity=-1),Opal.def(self,"$resolve!",$Promise_inspect$31=function(value){var $$17;return this.realized="resolve",this.value=value,$truthy(this.next["$any?"]())?$send(this.next,"each",[],(($$17=function(p){null==$$17.$$s||$$17.$$s;return null==p&&(p=nil),p.$resolve(value)}).$$s=this,$$17.$$arity=1,$$17)):this.delayed=[value]},$Promise_inspect$31.$$arity=1),Opal.def(self,"$reject",$Promise_inspect$31=function(value){var e,self=this,block=nil,$ret_or_4=nil;if(null==value&&(value=nil),$truthy(self["$realized?"]())&&self.$raise($$($nesting,"ArgumentError"),"the promise has already been realized"),$truthy($$($nesting,"Promise")["$==="](value)))return value["$<<"](self.prev)["$^"](self);try{block=$truthy($ret_or_4=self.action["$[]"]("failure"))?$ret_or_4:self.action["$[]"]("always"),$truthy(block)&&(value=block.$call(value)),$truthy(self.action["$key?"]("always"))?self["$resolve!"](value):self["$reject!"](value)}catch($err){if(!Opal.rescue($err,[$$($nesting,"Exception")]))throw $err;e=$err;try{self["$exception!"](e)}finally{Opal.pop_exception()}}return self},$Promise_inspect$31.$$arity=-1),Opal.def(self,"$reject!",$Promise_inspect$31=function(value){var $$20;return this.realized="reject",this.error=value,$truthy(this.next["$any?"]())?$send(this.next,"each",[],(($$20=function(p){null==$$20.$$s||$$20.$$s;return null==p&&(p=nil),p.$reject(value)}).$$s=this,$$20.$$arity=1,$$20)):this.delayed=[value]},$Promise_inspect$31.$$arity=1),Opal.def(self,"$exception!",$Promise_inspect$31=function(error){return this.exception=!0,this["$reject!"](error)},$Promise_inspect$31.$$arity=1),Opal.def(self,"$then",$Promise_then$22=function(){var $iter=$Promise_then$22.$$p,block=$iter||nil;return $iter&&($Promise_then$22.$$p=null),$iter&&($Promise_then$22.$$p=null),this["$^"]($$($nesting,"Promise").$new($hash2(["success"],{success:block})))},$Promise_then$22.$$arity=0),Opal.def(self,"$then!",$Promise_then$excl$23=function(){var $iter=$Promise_then$excl$23.$$p,block=$iter||nil;return $iter&&($Promise_then$excl$23.$$p=null),$iter&&($Promise_then$excl$23.$$p=null),this["$there_can_be_only_one!"](),$send(this,"then",[],block.$to_proc())},$Promise_then$excl$23.$$arity=0),Opal.alias(self,"do","then"),Opal.alias(self,"do!","then!"),Opal.def(self,"$fail",$Promise_fail$24=function(){var $iter=$Promise_fail$24.$$p,block=$iter||nil;return $iter&&($Promise_fail$24.$$p=null),$iter&&($Promise_fail$24.$$p=null),this["$^"]($$($nesting,"Promise").$new($hash2(["failure"],{failure:block})))},$Promise_fail$24.$$arity=0),Opal.def(self,"$fail!",$Promise_fail$excl$25=function(){var $iter=$Promise_fail$excl$25.$$p,block=$iter||nil;return $iter&&($Promise_fail$excl$25.$$p=null),$iter&&($Promise_fail$excl$25.$$p=null),this["$there_can_be_only_one!"](),$send(this,"fail",[],block.$to_proc())},$Promise_fail$excl$25.$$arity=0),Opal.alias(self,"rescue","fail"),Opal.alias(self,"catch","fail"),Opal.alias(self,"rescue!","fail!"),Opal.alias(self,"catch!","fail!"),Opal.def(self,"$always",$Promise_always$26=function(){var $iter=$Promise_always$26.$$p,block=$iter||nil;return $iter&&($Promise_always$26.$$p=null),$iter&&($Promise_always$26.$$p=null),this["$^"]($$($nesting,"Promise").$new($hash2(["always"],{always:block})))},$Promise_always$26.$$arity=0),Opal.def(self,"$always!",$Promise_always$excl$27=function(){var $iter=$Promise_always$excl$27.$$p,block=$iter||nil;return $iter&&($Promise_always$excl$27.$$p=null),$iter&&($Promise_always$excl$27.$$p=null),this["$there_can_be_only_one!"](),$send(this,"always",[],block.$to_proc())},$Promise_always$excl$27.$$arity=0),Opal.alias(self,"finally","always"),Opal.alias(self,"ensure","always"),Opal.alias(self,"finally!","always!"),Opal.alias(self,"ensure!","always!"),Opal.def(self,"$trace",$Promise_trace$28=function(depth){var $iter=$Promise_trace$28.$$p,block=$iter||nil;return $iter&&($Promise_trace$28.$$p=null),$iter&&($Promise_trace$28.$$p=null),null==depth&&(depth=nil),this["$^"]($$($nesting,"Trace").$new(depth,block))},$Promise_trace$28.$$arity=-1),Opal.def(self,"$trace!",$Promise_trace$excl$29=function($a){var args=$Promise_trace$excl$29.$$p,block=args||nil;return args&&($Promise_trace$excl$29.$$p=null),args&&($Promise_trace$excl$29.$$p=null),args=Opal.slice.call(arguments,0,arguments.length),this["$there_can_be_only_one!"](),$send(this,"trace",Opal.to_a(args),block.$to_proc())},$Promise_trace$excl$29.$$arity=-1),Opal.def(self,"$there_can_be_only_one!",$Promise_inspect$31=function(){return $truthy(this.next["$any?"]())?this.$raise($$($nesting,"ArgumentError"),"a promise has already been chained"):nil},$Promise_inspect$31.$$arity=0),Opal.def(self,"$inspect",$Promise_inspect$31=function(){var self=this,result=nil,$ret_or_5=nil,result="#<"+self.$class()+"("+self.$object_id()+")";return $truthy(self.next["$any?"]())&&(result=$rb_plus(result," >> "+self.next.$inspect())),result=$rb_plus(result,$truthy(self["$realized?"]())?": "+($truthy($ret_or_5=self.value)?$ret_or_5:self.error).$inspect()+">":">")},$Promise_inspect$31.$$arity=0),function($base,self,$Trace_it$32){var $Trace_initialize$33,$nesting=[self=$klass($base,self,"Trace")].concat($Trace_it$32);Opal.defs(self,"$it",$Trace_it$32=function(promise){var prev,current=nil,$ret_or_6=nil,current=[];return $truthy($truthy($ret_or_6=promise["$act?"]())?$ret_or_6:promise.$prev()["$nil?"]())&&current.$push(promise.$value()),prev=promise.$prev(),$truthy(prev)?current.$concat(this.$it(prev)):current},$Trace_it$32.$$arity=1),Opal.def(self,"$initialize",$Trace_initialize$33=function(depth,block){var $$34,$iter=$Trace_initialize$33.$$p;return $iter&&($Trace_initialize$33.$$p=null),this.depth=depth,$send2(this,Opal.find_super_dispatcher(this,"initialize",$Trace_initialize$33,!1,!0),"initialize",[$hash2(["success"],{success:$send(this,"proc",[],(($$34=function(){var $ret_or_7,lhs,rhs=null==$$34.$$s?this:$$34.$$s,trace=nil;return(trace=$$($nesting,"Trace").$it(rhs).$reverse()).$pop(),$truthy($truthy($ret_or_7=depth)?(lhs=depth,rhs=trace.$length(),"number"==typeof lhs&&"number"==typeof rhs?lhs<=rhs:lhs["$<="](rhs)):$ret_or_7)&&trace.$shift(function(lhs,rhs){return"number"==typeof lhs&&"number"==typeof rhs?lhs-rhs:lhs["$-"](rhs)}(trace.$length(),depth)),$send(block,"call",Opal.to_a(trace))}).$$s=this,$$34.$$arity=0,$$34))})],null)},$Trace_initialize$33.$$arity=2)}($nesting[0],self,$nesting),function($base,$When_try$47,$When_wait$43){var $When_initialize$35,$When_each$37,$When_collect$39,$When_inject$41,$When_$gt$gt$45,$When_try$47=$klass($base,$When_try$47,"When"),$nesting=[$When_try$47].concat($When_wait$43);return $When_try$47.$$prototype.wait=nil,Opal.def($When_try$47,"$initialize",$When_initialize$35=function(promises){var $$36,$iter=$When_initialize$35.$$p;return $iter&&($When_initialize$35.$$p=null),null==promises&&(promises=[]),$send2(this,Opal.find_super_dispatcher(this,"initialize",$When_initialize$35,!1,!0),"initialize",[],null),this.wait=[],$send(promises,"each",[],(($$36=function(promise){var self=null==$$36.$$s?this:$$36.$$s;return null==promise&&(promise=nil),self.$wait(promise)}).$$s=this,$$36.$$arity=1,$$36))},$When_initialize$35.$$arity=-1),Opal.def($When_try$47,"$each",$When_each$37=function(){var $$38,$iter=$When_each$37.$$p,block=$iter||nil;return $iter&&($When_each$37.$$p=null),$iter&&($When_each$37.$$p=null),$truthy(block)||this.$raise($$($nesting,"ArgumentError"),"no block given"),$send(this,"then",[],(($$38=function(values){null==$$38.$$s||$$38.$$s;return null==values&&(values=nil),$send(values,"each",[],block.$to_proc())}).$$s=this,$$38.$$arity=1,$$38))},$When_each$37.$$arity=0),Opal.def($When_try$47,"$collect",$When_collect$39=function(){var $$40,$iter=$When_collect$39.$$p,block=$iter||nil;return $iter&&($When_collect$39.$$p=null),$iter&&($When_collect$39.$$p=null),$truthy(block)||this.$raise($$($nesting,"ArgumentError"),"no block given"),$send(this,"then",[],(($$40=function(values){null==$$40.$$s||$$40.$$s;return null==values&&(values=nil),$$($nesting,"When").$new($send(values,"map",[],block.$to_proc()))}).$$s=this,$$40.$$arity=1,$$40))},$When_collect$39.$$arity=0),Opal.def($When_try$47,"$inject",$When_inject$41=function($a){var args,$$42,$post_args=$When_inject$41.$$p,block=$post_args||nil;return $post_args&&($When_inject$41.$$p=null),$post_args&&($When_inject$41.$$p=null),$post_args=Opal.slice.call(arguments,0,arguments.length),args=$post_args,$send(this,"then",[],(($$42=function(values){null==$$42.$$s||$$42.$$s;return null==values&&(values=nil),$send(values,"reduce",Opal.to_a(args),block.$to_proc())}).$$s=this,$$42.$$arity=1,$$42))},$When_inject$41.$$arity=-1),Opal.alias($When_try$47,"map","collect"),Opal.alias($When_try$47,"reduce","inject"),Opal.def($When_try$47,"$wait",$When_wait$43=function(promise){var $$44;return $truthy($$($nesting,"Promise")["$==="](promise))||(promise=$$($nesting,"Promise").$value(promise)),$truthy(promise["$act?"]())&&(promise=promise.$then()),this.wait["$<<"](promise),$send(promise,"always",[],(($$44=function(){var self=null==$$44.$$s?this:$$44.$$s;return null==self.next&&(self.next=nil),$truthy(self.next["$any?"]())?self.$try():nil}).$$s=this,$$44.$$arity=0,$$44)),this},$When_wait$43.$$arity=1),Opal.alias($When_try$47,"and","wait"),Opal.def($When_try$47,"$>>",$When_$gt$gt$45=function($a){var $$46,$zuper_ii,$iter=$When_$gt$gt$45.$$p,$zuper=nil,$zuper_i=nil;for($iter&&($When_$gt$gt$45.$$p=null),$zuper_i=0,$zuper_ii=arguments.length,$zuper=new Array($zuper_ii);$zuper_i<$zuper_ii;$zuper_i++)$zuper[$zuper_i]=arguments[$zuper_i];return Opal.slice.call(arguments,0,arguments.length),$send($send2(this,Opal.find_super_dispatcher(this,">>",$When_$gt$gt$45,!1,!0),">>",$zuper,$iter),"tap",[],(($$46=function(){return(null==$$46.$$s?this:$$46.$$s).$try()}).$$s=this,$$46.$$arity=0,$$46))},$When_$gt$gt$45.$$arity=-1),Opal.def($When_try$47,"$try",$When_try$47=function(){var promise=nil;return $truthy($send(this.wait,"all?",[],"realized?".$to_proc()))?(promise=$send(this.wait,"find",[],"rejected?".$to_proc()),$truthy(promise)?this.$reject(promise.$error()):this.$resolve($send(this.wait,"map",[],"value".$to_proc()))):nil},$When_try$47.$$arity=0),nil&&"try"}($nesting[0],self,$nesting)}($nesting[0],$nesting)};
